---
category: 其它
---

## 对加密、搜索、认证授权的一点想法

### 依照Https加密思想实现接口加密功能

1. 服务端生成一对非对称密钥，公钥publicKey，私钥privateKey, 将其暂存起来，使用MD5计算publicKey的摘要s，将s与publicKey按一定的规则混合(这个规则为服务端和客户端约定，防止中间人攻击)，将混合后的串发送给客户端。

2. 客户端接收数据后以后，按照约定的混合规则解析出publicKey与s，使用MD5计算publicKey的摘要s1,若s与s1相等，则认为此公钥确实为服务端所发。

3. 客户端生成一把对称密钥key，存在本地，并使用publicKey加密后发送给服务端，服务端获取到key后使用privateKey解密。自此，客户端与服务器完成了密钥的安全传输，后续若需要传输重要数据，则使用此密钥来加密传输。

### 基于Redis与倒排索引思想构建简易搜索引擎

1. 给出数据源名称(表名)，表中所有行数据，每行需包含主键key、所有可被搜索的字段数据的拼接s。

2. 根据这些信息建立倒排索引：遍历每行数据，对s进行分词，得到词语列表[s1,s2,s3..]，以每个词语为键，Set为值，将该行主键加入该词语对应的Set。最终我们将得到一个倒排索引集：s1:{1, 2, 3}，s2{1,5,6,7}, s3{1,2,4,8}...

3. 当我们进行搜索的时候，输入搜索句子str，则对str进行分词得到[word1, word2, word3...]，获取到这些词的对应的Set，若将这些Set进行交集，则表示查找包含所有关键词的数据主键；若进行并集，则表示查找包含搜索序列中任意关键词的数据主键。

4. 使用计算所得主键集进行批量查询。

5. 当某行数据被修改时，对旧数据进行分词得到oldWords，对新数据进行分词得到newWords,两者进行交集得到mixWords，对mixWords与oldWords进行差集，删除该结果集合中的词语对应的Set中的该行数据主键；对mixWords与oldWords进行差集，在该结果集合中的词语对应的Set中的该行数据主键。

6. 当某行数据被删除时，对该数据进行分词得到words, 删除该集合中的词语对应的Set中的该行数据主键。

7. 当新增某行数据时，对该数据进行分词得到words, 在该集合中的词语对应的Set中的该行数据主键

8. (5、6、7)都是对倒排索引集的维护，不涉及主要业务，因此都可以用异步任务来处理。

优点：大大提高了查询速度(避免了查询所有数据进行关键词匹配判断、使用主键批量查询避免了回表，大部分操作依赖于集合运算)

缺点：redis容量有限，若经常有数据写入或删除操作，需维护倒排索引集会影响效率。

### 实现统一认证授权中心

#### (1)技术选型

使用JWT、Gateway、策略模式、模板模式、Oauth2.0

#### (2)功能要点

1. 集成多种登录方式(第三方应用登录、用户名密码登录、邮箱验证码登录、手机验证码登录)
2. 实现基于RBAC的权限控制
3. 保证可扩展性和可维护性

#### (3) 实现方案

1. 认证授权中心负责认证、授权、JWT管理，网关负责校验认证和鉴权，其他API服务负责处理自己的业务逻辑

2. 无论什么登录方式，核心诉求就是验证用户是否为本系统信任用户。对于第三方登录，只要可以获取到其第三方身份信息且，便认为其是值得信任的；对于用户名密码，只要可以查找到对于用户且其密码正确，便认为其是值得信任的；对于邮箱、手机验证码登录，只要其验证码校验通过，便认为其是值得信任的。

3. 为了便于统一管理，除用户名密码登录以外，使用其它登录方式第一次登录时会在本系统中生成其对应的用户信息，以及用户与第三方账号的关联信息、用户角色关联信息等。

4. 定义一个BaseLoginService基类，在其中定义登录的基本流程：身份校验 ==> 获取信息 ==> 生成JWT; 其中身份校验与获取信息为抽象方法，由子类实现(模板模式)。

5. 定义三个子类UsernamePasswordLoginService、ThirdPartyLoginService、ValidCodeLoginService。

6. 对于UsernamePasswordLoginService，身份校验流程如下：

   - 判断用户名、密码是否为空
   - 判断用户名是否有效
   - 判断密码是否正确

   获取信息则根据用户名在数据库查找即可。

7. 对于ThirdPartyLoginService，身份校验判断传入的第三方应用身份信息是否为空即可；获取信息则根据第三方账号的关联表通过联表查询获取用户信息。

8. 对于ValidCodeLoginService，身份校验通过判断验证码是否过期并且正确即可；获取信息则通过邮箱或者手机号查询用户即可。

9. 在ThirdPartyLoginService，还应定义对应的获取第三方应用身份信息并进行统一封装的流程：用户在第三方应用授权界面授权后，第三方应用发送授权码到本系统在对应第三方应用中注册的回调接口，我们需要通过此授权码获取到Access Token，携带对应此token，获取用户在第三方应用中的身份信息，将其统一封装以后传入ThirdPartyLoginService的身份校验方法中。

10. 我们在登录时，根据不同的登录方式，传入对应的枚举值，根据该枚举值获取到对应的LoginService，进行登录认证(策略模式)。

11. 登录校验成功后，需要为该用户生成JWT，其中JWT的负载除基本字段以外，还需存储用户常用信息以及角色信息。

12. 每个用户有多个角色，每个角色有多个权限