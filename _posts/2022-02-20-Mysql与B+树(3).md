---
category: 数据库
---



## Mysql与B+树(3)

在[Mysql与B+树(2)](https://yedong666.github.io/blogs/%E6%95%B0%E6%8D%AE%E5%BA%93/2022/02/15/Mysql%E4%B8%8EB+%E6%A0%91(2).html)中我根据自己的理解分析了一下创建索引对性能的影响，本篇文章我想讲一些由此引申出的概念：回表、索引下推、索引覆盖。

### 回表

回表是Mysql中的一个重要概念，许多操作会导致大量无用的回表查询，严重降低查询速度。那么什么是回表呢？

在根据非聚簇索引进行查询的时候，我们会发现对非聚簇索引树的遍历的最终结果只是得到了主键ID，想要获得我们需要的数据还得去遍历聚簇索引，这个操作就被称为回表，回表意味着IO次数的增加、需要遍历的元素增多，因此大大降低了查询效率。

基于这个原因，我们的宗旨就是能在非聚簇索引完成的事，就不要去遍历聚簇索引树了。

### 索引覆盖（Covering Index）

索引覆盖就是对上述宗旨的践行。非聚簇索引的字段可能有一个多个，同时我们并不是任何时候都需要数据的所有字段，那么当我们需要查询的字段被包含在我们建立的某个索引里面时，通过该索引进行一次遍历即可获取到我们需要的数据。

你可能会疑惑，那为什么不将所有字段建立一个联合索引呢，这样的话岂不是什么查询都能被覆盖。这个想法忽略了一个问题，在Mysql中B+树的结点大小是固定的，索引的字段越多，则单个元素的占用空间就越大，结点能够存储的元素就越少，意味着我们需要更多的节点来存放这些元素，而更多的结点则意味着B+树的高度会变高，使得查询的IO次数变多；并且其这样的B+树的维护以及元素之间的比较时的性能消耗也会跟着大大提高。

总结起来就一句话，索引不是覆盖的字段越多越好。

### 索引下推（Index Condition Pushdown）

索引下推是MySQL数据库的一种优化技术，它可以将部分查询条件下推至存储引擎层面进行处理，从而减少需要返回给MySQL服务器层面的数据量，提高查询性能。

具体来说，当MySQL服务器执行查询语句时，优化器会根据查询条件选择适当的索引进行查询。如果使用的是覆盖索引，也就是索引包含了所有需要查询的列，那么查询结果可以直接从索引中返回，不需要再到数据表中查找。但如果索引只包含了部分需要查询的列，或者需要在数据表中查找满足条件的数据行，那么查询就需要进行两次访问：首先访问索引，找到符合条件的主键或行号，然后再到数据表中查找相应的数据行。

为了减少这种两次访问的开销，MySQL引入了索引下推技术。具体来说，当优化器选择使用索引进行查询时，它会将查询条件分为两类：一类是可以直接在索引中判断的条件，比如等值查询、范围查询等；另一类是需要在数据表中判断的条件，比如包含了函数、表达式、子查询等。优化器会将第一类条件下推至存储引擎层面进行处理，而不是等待到数据表层面再进行判断。这样可以减少需要返回给MySQL服务器层面的数据量，提高查询性能。

### Mysql其它优化技术和算法

1. 最左前缀匹配（Leftmost Prefix Matching）：在使用联合索引时，如果查询条件只包含索引的前缀部分，那么可以利用最左前缀匹配的特性，避免不必要的索引扫描。
2. 索引选择性（Index Selectivity）：索引选择性是指索引中不同值的数量与数据表中总行数之比，选择性越高的索引能够过滤掉更多的数据，因此查询性能越好。
3. 查询优化器（Query Optimizer）：MySQL的查询优化器可以对查询语句进行分析和优化，选择合适的索引和查询计划，从而提高查询性能。

### 结语

写了三篇和Mysql索引相关的文章，在这个过程中一边思考，一边查询资料，同时举一些简单的例子来进行分析，我有感觉得到自己对索引的理解和Mysql的查询优化有了进一步的提升。

注：本篇文章仅是自己的一点总结和思考，错误之处还请指正；同时本篇文章参考了[知乎关于索引下推的这个回答](https://www.zhihu.com/question/588200730/answer/2926897257)

